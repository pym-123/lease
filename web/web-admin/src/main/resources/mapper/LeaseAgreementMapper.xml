<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.atguigu.lease.web.admin.mapper.LeaseAgreementMapper">
    <resultMap id="voPageResultMap" type="com.atguigu.lease.web.admin.vo.agreement.AgreementVo" autoMapping="true">
        <id column="id" property="id"/>
        <association property="apartmentInfo" javaType="com.atguigu.lease.model.entity.ApartmentInfo" autoMapping="true">
            <result column="ai_id" property="id"/>
            <result column="ai_is_release" property="isRelease"/>
            <result column="ai_name" property="name"/>
        </association>
        <association property="leaseTerm" javaType="com.atguigu.lease.model.entity.LeaseTerm"  autoMapping="true">
            <result column="lt_id" property="id"/>
        </association>
        <association property="paymentType" javaType="com.atguigu.lease.model.entity.PaymentType" autoMapping="true">
            <result column="pt_id" property="id"/>
            <result column="pt_name" property="name"/>
        </association>
        <association property="roomInfo" javaType="com.atguigu.lease.model.entity.RoomInfo" autoMapping="true">
            <result column="ri_id" property="id"/>
            <result column="ri_is_release" property="isRelease"/>
            <result column="ri_rent" property="rent"/>
        </association>
    </resultMap>
    <select id="voPage" resultMap="voPageResultMap">
        SELECT
            la.*,
            pt.id pt_id,
            pt.NAME pt_name,
            pt.pay_month_count,
            pt.additional_info,
            lt.id lt_id,
            lt.month_count,
            lt.unit,
            ri.id ri_id,
            ri.apartment_id,
            ri.is_release ri_is_release,
            ri.rent ri_rent,
            ri.room_number,
            ai.address_detail,
            ai.city_id,
            ai.city_name,
            ai.district_id,
            ai.district_name,
            ai.id ai_id,
            ai.introduction,
            ai.is_release ai_is_release,
            ai.latitude,
            ai.longitude,
            ai.NAME ai_name,
            ai.province_id,
            ai.province_name
        FROM
            lease_agreement la,
            payment_type pt,
            lease_term lt,
            room_info ri,
            apartment_info ai
        <where>
            la.payment_type_id = pt.id
            AND lt.id = la.lease_term_id
            AND ai.id = la.apartment_id
            AND ri.id = la.room_id
            AND la.is_deleted = 0
            AND pt.is_deleted = 0
            AND lt.is_deleted = 0
            AND ai.is_deleted = 0
            AND ri.is_deleted = 0
            <if test="queryVo.provinceId!=null">
                and ai.province_id = #{queryVo.provinceId}
            </if>
            <if test="queryVo.cityId!=null">
                and ai.city_id = #{queryVo.cityId}
            </if>
            <if test="queryVo.districtId!=null">
                and ai.district_id = #{queryVo.districtId}
            </if>
            <if test="queryVo.apartmentId!=null">
                and la.province_id = #{queryVo.apartmentId}
            </if>
            <if test="queryVo.roomNumber!=null and query.roomNumber!=''">
                and ri.room_number like "%"#{query.roomNumber}"%"
            </if>
            <if test="queryVo.name!=null and queryVo.name!=''">
                and like "%"#{queryVo.name}"%"
            </if>
            <if test="queryVo.phone!=null and queryVo.phone!=''">
                and like "%"#{queryVo.phone}"%"
            </if>
        </where>


    </select>
    <select id="selectAgreementVoById" resultMap="voPageResultMap">
        SELECT
            la.*,
            pt.id pt_id,
            pt.NAME pt_name,
            pt.pay_month_count,
            pt.additional_info,
            lt.id lt_id,
            lt.month_count,
            lt.unit,
            ri.id ri_id,
            ri.apartment_id,
            ri.is_release ri_is_release,
            ri.rent ri_rent,
            ri.room_number,
            ai.address_detail,
            ai.city_id,
            ai.city_name,
            ai.district_id,
            ai.district_name,
            ai.id ai_id,
            ai.introduction,
            ai.is_release ai_is_release,
            ai.latitude,
            ai.longitude,
            ai.NAME ai_name,
            ai.province_id,
            ai.province_name
        FROM
            lease_agreement la,
            payment_type pt,
            lease_term lt,
            room_info ri,
            apartment_info ai
        WHERE
            la.payment_type_id = pt.id
            AND lt.id = la.lease_term_id
            AND ai.id = la.apartment_id
            AND ri.id = la.room_id
            AND la.is_deleted = 0
            AND pt.is_deleted = 0
            AND lt.is_deleted = 0
            AND ai.is_deleted = 0
            AND ri.is_deleted = 0
            AND la.id = #{id}
    </select>
    <select id="selectBusyRoomId" resultType="java.lang.Long">
        select room_id from lease_agreement where apartment_id = #{id} and status in (2,5,7) and is_deleted = 0
    </select>
</mapper>
